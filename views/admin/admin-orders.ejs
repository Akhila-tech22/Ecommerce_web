<%- include('../partials/admin/header') %>
<!-- Bootstrap 5 CSS CDN -->
 
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  :root {
    --primary-color: #1e90ff;
    --secondary-color: #2d3436;
    --success-color: #00b894;
    --danger-color: #d63031;
    --info-color: #0984e3;
    --warning-color: #fdcb6e;
    --secondary-bg: #636e72;
    --light-gray: #dfe6e9;
    --background-color: #f5f6fa;
    --white: #ffffff;
    --shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
    --transition: all 0.3s ease;
    --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  body, .container-fluid {
    background-color: var(--background-color);
    font-family: var(--font-family);
    color: var(--secondary-color);
    margin-left: 116px;
    margin-top: 82px;
  }

  h1 {
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 1.5rem;
  }

  .card {
    border-radius: 0.5rem;
    box-shadow: var(--shadow);
    border: none;
    background-color: var(--white);
    transition: var(--transition);
    margin-left: 126px;
  }

  .card-header {
    font-weight: 600;
    font-size: 1.2rem;
    color: var(--secondary-color);
    background-color: var(--light-gray);
    border-bottom: 1px solid #ccc;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .card-header i {
    color: var(--primary-color);
  }

  /* Search Section */
  .search-section {
    background-color: var(--white);
    padding: 20px;
    border-radius: 0.5rem;
    box-shadow: var(--shadow);
    margin-bottom: 20px;
    margin-left: 126px;
  }

  .search-section .form-control {
    border-radius: 0.4rem;
    border: 1px solid #ccc;
    transition: border-color 0.3s ease;
  }

  .search-section .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 6px rgba(30, 144, 255, 0.3);
  }

  .table-responsive {
    overflow-x: auto;
  }

  table.order-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 0.7rem;
  }

  table.order-table thead th {
    text-transform: uppercase;
    font-weight: 700;
    color: var(--secondary-bg);
    border-bottom: 2px solid var(--primary-color);
    padding: 12px 15px;
    background-color: transparent;
    cursor: pointer;
    user-select: none;
    position: relative;
  }

  table.order-table thead th:hover {
    background-color: rgba(30, 144, 255, 0.1);
  }

  table.order-table thead th .sort-icon {
    margin-left: 5px;
    opacity: 0.5;
  }

  table.order-table thead th.sort-asc .sort-icon:after {
    content: "↑";
    opacity: 1;
  }

  table.order-table thead th.sort-desc .sort-icon:after {
    content: "↓";
    opacity: 1;
  }

  table.order-table tbody tr {
    background-color: var(--white);
    box-shadow: var(--shadow);
    transition: var(--transition);
    border-radius: 0.5rem;
  }

  table.order-table tbody tr:hover {
    box-shadow: 0 10px 30px rgba(30, 144, 255, 0.15);
  }

  table.order-table tbody td {
    vertical-align: middle;
    padding: 12px 15px;
    color: var(--secondary-color);
    font-size: 0.95rem;
  }

  /* Status badges with refined colors */
  .status-badge {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 15px;
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--white);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    user-select: none;
    transition: var(--transition);
    min-width: 110px;
    text-align: center;
  }
  .bg-success { background-color: var(--success-color); }
  .bg-danger { background-color: var(--danger-color); }
  .bg-info { background-color: var(--info-color); }
  .bg-warning { background-color: var(--warning-color); color: #2d3436; }
  .bg-secondary { background-color: var(--secondary-bg); }

  /* Product image and name alignment */
  .order-table tbody td img {
    border-radius: 6px;
    box-shadow: 0 0 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
  }
  .order-table tbody td img:hover {
    transform: scale(1.05);
  }

  .order-table tbody td div > div {
    line-height: 1.2;
  }

  /* Buttons in actions column */
  .order-actions .btn {
    margin: 0 4px 6px 0;
    font-size: 0.85rem;
    font-weight: 600;
    padding: 6px 12px;
    border-radius: 6px;
    transition: var(--transition);
  }

  .order-actions .btn-primary {
    background-color: var(--primary-color);
    border: none;
  }
  .order-actions .btn-primary:hover {
    background-color: #1764c0;
  }

  .order-actions .btn-success {
    background-color: var(--success-color);
    border: none;
  }
  .order-actions .btn-success:hover {
    background-color: #009e7f;
  }

  .order-actions .btn-danger {
    background-color: var(--danger-color);
    border: none;
  }
  .order-actions .btn-danger:hover {
    background-color: #b32424;
  }

  .order-actions .btn-info {
    background-color: var(--info-color);
    border: none;
  }
  .order-actions .btn-info:hover {
    background-color: #0661c3;
  }

  .bg-light {
    background-color: #f9f9f9 !important;
  }
  .bg-white {
    background-color: #ffffff !important;
  }

  /* No results message */
  .no-results {
    text-align: center;
    padding: 40px;
    color: var(--secondary-bg);
  }
</style>

<!-- Search Section -->
<div class="search-section">
  <div class="row">
    <div class="col-md-6">
      <div class="mb-3">
        <label for="searchInput" class="form-label">Search Orders</label>
        <input type="text" class="form-control" id="searchInput" placeholder="Search by Order ID, Customer Name, or Product Name">
      </div>
    </div>
    <div class="col-md-2">
      <div class="mb-3">
        <label class="form-label">&nbsp;</label>
        <button type="button" class="btn btn-secondary d-block w-100" id="clearSearch">
          <i class="fas fa-times"></i> Clear
        </button>
      </div>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header">
    <i class="fas fa-table me-1"></i>
    All Orders
    <span class="ms-auto" id="orderCount">Total: <%= orders.length %> orders</span>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped order-table">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Date</th>
            <th>Customer</th>
            <th>Products</th>
            <th>Total Amount</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="orderTableBody">
          <% orders.forEach((order, orderIndex) => { %>
            <tr class="order-row" 
                data-order-id="<%= order.orderId %>" 
                data-customer="<%= order.address.name %>" 
                data-date="<%= order.createdOn %>" 
                data-amount="<%= order.finalAmount %>"
                data-original-order-id="<%= order._id %>">
              <!-- Order ID -->
              <td class="fw-bold">#<%= order.orderId %></td>

              <!-- Date -->
              <td><%= new Date(order.createdOn).toLocaleDateString() %></td>

              <!-- Customer -->
              <td><strong><%= order.address.name %></strong></td>

              <!-- Products - Show all products in this order -->
              <td>
                <div class="products-list">
                  <% order.orderedItems.forEach((item, index) => { %>
                    <div class="product-item d-flex align-items-center mb-2" 
                         data-status="<%= item.status || order.status %>"
                         data-product-name="<%= item.productName.toLowerCase() %>">
                      <img src="/<%= item.productImages[0] %>" 
                           alt="<%= item.productName %>" 
                           style="width: 40px; height: 40px; object-fit: cover;" 
                           class="me-2 rounded">
                      <div class="product-info">
                        <div class="product-name"><%= item.productName %></div>
                        <small class="text-muted">Size: <%= item.size %> | Qty: <%= item.quantity %> | ₹<%= Math.round(item.price * item.quantity) %></small>
                        <div>
                          <span class="status-badge <%= 
                            (item.status || order.status) === 'delivered' ? 'bg-success' :
                            (item.status || order.status) === 'cancelled' ? 'bg-danger' :
                            (item.status || order.status) === 'shipped' ? 'bg-info' :
                            (item.status || order.status) === 'return_requested' ? 'bg-warning' :
                            (item.status || order.status) === 'approved' ? 'bg-info' :
                            (item.status || order.status) === 'rejected' ? 'bg-secondary' :
                            'bg-warning'
                          %>" style="font-size: 0.7rem; padding: 2px 8px; min-width: auto;">
                            <%= (item.status || order.status).toUpperCase() %>
                          </span>
                        </div>
                      </div>
                    </div>
                    <% if (index < order.orderedItems.length - 1) { %>
                      <hr class="my-2 product-separator">
                    <% } %>
                  <% }); %>
                </div>
              </td>

              <!-- Total Amount -->
              <td class="fw-bold">₹<%= Math.round(order.finalAmount) %></td>

              <!-- Actions - One per Order -->
              <td class="order-actions">
                <a href="/admin/orders/<%= order._id %>" class="btn btn-primary btn-sm mb-1">
                  View Details
                </a>
             
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
      <div id="noResults" class="no-results" style="display: none;">
        <i class="fas fa-search fa-3x mb-3"></i>
        <h5>No orders found</h5>
        <p>Try adjusting your search criteria</p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Global variables for search
let allOrders = [];
let filteredOrders = [];

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Store all orders data with their products
  allOrders = Array.from(document.querySelectorAll('.order-row')).map(row => {
    const products = Array.from(row.querySelectorAll('.product-item')).map(productEl => ({
      element: productEl,
      status: productEl.dataset.status,
      name: productEl.dataset.productName
    }));
    
    return {
      element: row,
      orderId: row.dataset.orderId,
      customer: row.dataset.customer.toLowerCase(),
      date: new Date(row.dataset.date),
      amount: parseFloat(row.dataset.amount),
      originalOrderId: row.dataset.originalOrderId,
      products: products,
      allProductNames: products.map(p => p.name).join(' ')
    };
  });
  
  filteredOrders = [...allOrders];
  
  // Add event listeners
  document.getElementById('searchInput').addEventListener('input', applySearch);
  document.getElementById('clearSearch').addEventListener('click', clearSearch);
});

function applySearch() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  
  // Apply search filter
  filteredOrders = allOrders.filter(order => {
    // Search filter
    const matchesSearch = !searchTerm || 
      order.orderId.toLowerCase().includes(searchTerm) ||
      order.customer.includes(searchTerm) ||
      order.allProductNames.includes(searchTerm);
    
    return matchesSearch;
  });
  
  renderTable();
  updateOrderCount();
}



function updateOrderCount() {
  const countText = `Total: ${filteredOrders.length} orders`;
  document.getElementById('orderCount').textContent = countText;
}

function clearSearch() {
  document.getElementById('searchInput').value = '';
  applySearch();
}



// Return handling functions (keeping existing functionality)
function handleReturn(orderId, productId, newStatus, size) {
  Swal.fire({
    title: `Are you sure you want to ${newStatus === 'approved' ? 'approve' : 'reject'} this return?`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: newStatus === 'approved' ? '#28a745' : '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: `Yes, ${newStatus}`
  }).then((result) => {
    if (result.isConfirmed) {
      fetch('/admin/orders/handle-return', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ orderId, productId, newStatus, size })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: data.message
          }).then(() => location.reload());
        } else {
          Swal.fire({ icon: 'error', title: 'Error', text: data.message });
        }
      })
      .catch(err => {
        console.error("Fetch error:", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Something went wrong!' });
      });
    }
  });
}
</script>

<%- include('../partials/admin/footer') %>