<%- include("../../views/partials/user/header") %>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<head>
  <link rel="stylesheet" href="css/linearicons.css">
  <link rel="stylesheet" href="css/font-awesome.min.css">
  <link rel="stylesheet" href="css/themify-icons.css">
  <link rel="stylesheet" href="css/bootstrap.css">
  <link rel="stylesheet" href="css/owl.carousel.css">
  <link rel="stylesheet" href="css/nice-select.css">
  <link rel="stylesheet" href="css/nouislider.min.css">
  <link rel="stylesheet" href="css/ion.rangeSlider.css" />
  <link rel="stylesheet" href="css/ion.rangeSlider.skinFlat.css" />
  <link rel="stylesheet" href="css/magnific-popup.css">
  <link rel="stylesheet" href="css/main.css">
</head>

<style>
.card-green {
  background-color: #ADD8E6;
}

.main {
  padding: 30px 0;
}

.dashboard-menu {
  background-color: #cce3e6;
  border-radius: 10px;
  padding: 15px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

.dashboard-menu .nav-link {
  font-weight: bold;
  color: #30683c;
  box-shadow: 0 4px 10px rgba(123, 131, 112, 0.3), 0 4px 20px rgba(0, 191, 255, 0.2);
  transition: box-shadow 0.3s ease;
}

.dashboard-menu .nav-link:hover {
  color: #00bfff;
  box-shadow: 0 4px 15px rgba(173, 255, 47, 0.5), 0 6px 25px rgba(0, 191, 255, 0.4);
}

.card {
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
  margin-bottom: 20px;
}

.card-header {
  background-color: #487379;
  color: white;
  border-radius: 10px 10px 0 0;
}

.btn-success {
  background-color: #577194;
  border-color: #6bb87d;
}

.btn-success:hover {
  background-color: #506955;
}

.form-group {
  margin-bottom: 15px;
}

.required {
  color: red;
}

.page-header.breadcrumb-wrap {
  background-color: #eee2e9;
  padding: 15px 0;
}

.breadcrumb {
  display: flex;
  align-items: center;
  font-family: 'Arial', sans-serif;
  font-size: 16px;
  color: #121311;
}

.breadcrumb a {
  color: #007bff;
  text-decoration: none;
  position: relative;
  margin: 0 5px;
}

.breadcrumb a:hover {
  color: #0056b3;
}

.breadcrumb span {
  margin: 0 5px;
  color: #999;
}

.breadcrumb a::after {
  content: '';
  position: absolute;
  width: 100%;
  height: 2px;
  background: #6e6e3a;
  left: 0;
  bottom: -2px;
  transform: scaleX(0);
  transition: transform 0.3s ease;
}

.breadcrumb a:hover::after {
  transform: scaleX(1);
}

.profile-image-container {
  display: flex;
  align-items: center;
}

.rounded-circle {
  border-radius: 50%;
  border: 2px solid #fff;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.ml-3 {
  margin-left: 15px;
}

.cart-totals-container {
  width: 100%;
  max-width: 400px;
  padding: 16px;
  margin: 0 auto;
}

.cart-totals-container h2 {
  font-size: 1.125rem;
  font-weight: 600;
  margin-bottom: 16px;
}

.cart-totals-container hr {
  margin-bottom: 16px;
}

.cart-totals-container .flex {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.cart-totals-container .font-semibold {
  font-weight: 600;
}

.cart-totals-container .text-blue {
  color: blue;
}

.cart-totals-container .text-sm {
  font-size: 0.875rem;
}

.cart-totals-container .bg-yellow {
  background-color: #fbbf24;
}

.cart-totals-container .text-white {
  color: white;
}

.cart-totals-container .py-2 {
  padding-top: 8px;
  padding-bottom: 8px;
}

.cart-totals-container .rounded {
  border-radius: 4px;
}

.cart-totals-container .mb-4 {
  margin-bottom: 16px;
}

.cart-totals-container .block {
  display: block;
}

.cart-totals-container .text-center {
  text-align: center;
}

.cart-totals-container .apply-coupon-btn {
  padding: 8px 16px;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

/* Responsive Styles */
@media (max-width: 767px) {
  .shopping-summery .image img {
    width: 60px;
    height: 60px;
    object-fit: contain;
  }
  .shopping-summery .price, .shopping-summery .action {
    display: none;
  }
  .shopping-summery tr:only-child .price,
  .shopping-summery tr:only-child .action {
    display: block !important;
  }
  .shopping-summery tr:only-child .image img {
    width: 80px;
    height: 80px;
  }
}

/* Desktop Image Styling */
.shopping-summery .image img {
  width: 100px;
  height: 100px;
  object-fit: contain;
}
.btn:not(:disabled):not(.disabled) {
    cursor: pointer;
    margin-left: -3px;
}
</style>




<section class="banner-area organic-breadcrumb">
    <div class="container">
        <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
            <div class="col-first">
                <h1>Shopping Cart</h1>
                <nav class="d-flex align-items-center">
                    <a href="/">Home<span class="lnr lnr-arrow-right"></span></a>
                    <a href="/cart">Cart</a>
                </nav>
            </div>
        </div>
    </div>
</section>

<main class="main">
    <br><br>
    <section class="mt-50 mb-50">
        <div class="container">
            <div class="row">
                <div class="col-9">
                    <div class="table-responsive">
                        <table class="table shopping-summery text-center clean">
                            <thead>
                                <tr class="main-heading">
                                    <th scope="col">Image</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Price</th>
                                    <th scope="col">Quantity</th>
                                    <th scope="col">Remove</th>
                                </tr>
                            </thead>
                        <!-- Updated EJS template section - replace your existing tbody -->
<tbody>
    <% if (cartItems && cartItems.length > 0) { %>
        <% cartItems.forEach(function(item) { %>
            <tr>
                <td class="image product-thumbnail" data-title="Image">
                    <img src="<%= item.product.productImage[0] %>" alt="#" />
                </td>
                <td class="product-des product-name" data-title="Name">
                    <h5 class="product-name">            
                        <a href="/productDetails?id=<%= item.product._id %>"><%= item.product.productName %></a>
                    </h5>
                    <p class="font-xs">
                        <%= item.product.category.name %><br />
                        <%= item.product.brand %><br />
                        <strong>Size: <%= item.size %></strong>
                    </p>
                </td>
                <td class="price" data-title="Price">
                    ₹<span id="subTotal<%= item.product._id %>_<%= item.size %>"><%= item.totalPrice %></span><br>
                    <small class="text-muted text-nowrap">₹<span id="price<%= item.product._id %>_<%= item.size %>"><%= item.product.salePrice %></span> / per item</small>
                </td>
                <td class="text-center" data-title="Stock">
                    <div class="detail-qty border radius m-auto">
                        <div class="quantity-control">
                            <button class="btn btn-sm increment-button" onclick="changeQuantity('<%= item.product._id %>', 'increase', '<%= item.size %>')">+</button>
                            <input class="quantity-input" id="cartProductQuantity<%= item.product._id %>_<%= item.size %>" value="<%= item.quantity %>" style="width: 45px;" type="text" readonly>
                            <button class="btn btn-sm decrement-button" onclick="changeQuantity('<%= item.product._id %>', 'decrease', '<%= item.size %>')">-</button>
                        </div>
                    </div>
                </td>
                <td class="action" data-title="Remove">
                    <a class="btn btn-sm" href="#" onclick="confirmRemove('<%= item.product._id %>', '<%= item.size %>')">
                        <i class="fi-rs-trash">Remove</i>
                    </a>
                </td>
            </tr>
        <% }); %>
    <% } else { %>
        <tr>
            <td colspan="5" class="text-center">
                <p class="lead mb-4">No item found in Cart</p>
                <a href="/shop" class="btn btn-primary">Continue Shopping</a>
            </td>
        </tr>
    <% } %>
</tbody>
                        </table>
                    </div>
                </div>
                <div class="col-3">
                    <div class="cart-totals-container">
                        <h2>Cart Totals</h2>
                        <hr>
                       <div class="flex">
                        <span>Subtotal</span>
                        <span class="font-semibold">₹ <span id="grandTotal"><%= grandTotal %></span></span>
                        </div>
                        
                        <div class="flex">
                            <span>Shipping</span>
                            <div class="text-right">
                                <span class="font-semibold">₹ 50.00</span>
                                <br>
                                <a href="#" onclick="viewShippingCharge()" class="text-blue text-sm">View shipping charge</a>
                            </div>
                        </div>
                       <div class="flex mb-4">
                          <span>Total</span>
                          <span id="cartTotal" class="font-semibold text-blue">₹ <%= Math.round(grandTotal) + 50 %></span>
                        </div>
                        <% if (cartItems && cartItems.length > 0) { %>
                            <a href="/checkout" class="w-full bg-yellow text-white py-2 px-2 rounded mb-4">Proceed To Checkout</a>
                        <% } %>
                        <br>
                        <a href="/shop" class="block text-center text-blue mt-3">Continue Shopping</a>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Updated changeQuantity function - now includes size parameter
function changeQuantity(productId, action, size) {
    const quantityElement = document.getElementById(`cartProductQuantity${productId}_${size}`);
    let currentQuantity = parseInt(quantityElement.value);

    if (action === 'increase' && currentQuantity >= 5) {
        Swal.fire('Error', 'Maximum 5 quantity per user', 'error');
        return;
    }
    
    if (action === 'decrease' && currentQuantity <= 1) {
        confirmRemove(productId, size);
        return;
    }

    $.ajax({
        url: '/changeQuantity',
        method: 'POST',
        data: { productId: productId, action: action, size: size }, // Include size
        success: (response) => {
            if (response.status) {
                if (response.quantity === 0) {
                    // Item was removed
                    location.reload();
                } else {
                    // Update quantity in input box
                    quantityElement.value = response.quantity;

                    // Update subtotal for the product
                    const price = parseFloat(document.getElementById(`price${productId}_${size}`).innerText);
                    const newSubtotal = (price * response.quantity).toFixed(2);
                    document.getElementById(`subTotal${productId}_${size}`).innerText = newSubtotal;

                    // Update grand total and cart total
                    document.getElementById('grandTotal').innerText = response.grandTotal.toFixed(2);
                    document.getElementById('cartTotal').innerText = `₹ ${(Math.round(response.grandTotal) + 50).toFixed(2)}`;
                }
            } else {
                Swal.fire('Error', response.message, 'error');
            }
        },
        error: (error) => {
            console.error("AJAX Error:", error);
            Swal.fire('Error', 'An error occurred while updating the cart', 'error');
        }
    });
}

// Updated confirmRemove function - now includes size parameter
function confirmRemove(productId, size) {
    Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, remove it!'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: `/deleteItem?id=${productId}&size=${size}`, // Include size in query
                method: 'GET',
                success: (response) => {
                    if (response.status) {
                        Swal.fire('Removed!', response.message, 'success');
                        location.reload();
                    } else {
                        Swal.fire('Error', response.message, 'error');
                    }
                },
                error: (error) => {
                    console.error("AJAX Error:", error);
                    Swal.fire('Error', 'There was an error removing the item from the cart', 'error');
                }
            });
        }
    });
}

function viewShippingCharge() {
    Swal.fire({
        title: 'Shipping Charge',
        text: 'Shipping charge is ₹ 50.00 For All Orders',
        icon: 'info',
        confirmButtonText: 'OK'
    });
}
</script>

<%- include("../../views/partials/user/footer") %>